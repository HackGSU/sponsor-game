<!doctype html>
<html lang='en'>
<head>
  <meta charset="utf-8">
  <title>Attack of the Sponsors</title>
  <script src="js/helpers.js"></script>
  <style>
  #myStartScreen {
    background-image: url(stars.gif);
    position: absolute;
    margin: auto;
    margin-top: 30px;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  canvas {
    background-image: url(stars.gif);
    display: block;
    position: absolute;
    margin: auto;
    margin-top: 30px;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  #myCreditsScreen {
    background-image: url(stars.gif);
    position: absolute;
    margin: auto;
    margin-top: 30px;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
  </style>
</head>
<body>
  <script>
    var screen, input, frames;
    var sponserSprite, plSprite, bossSprite, waveCount;
    var aliens, dir, player, projectiles, cities;

    function mainGame() {
      screen = new Screen(504, 600);
      input = new InputHandler();

      var img = new Image();
      img.addEventListener("load", function() {
        sponserSprite = [
          [new Sprite(this, 0, 0, 22, 16), new Sprite(this, 0, 0, 22, 16)],
          [new Sprite(this, 0, 0, 22, 16), new Sprite(this, 0, 0, 22, 16)],
          [new Sprite(this, 0, 0, 22, 16), new Sprite(this, 0, 0, 22, 16)],
          [new Sprite(this, 0, 0, 22, 16), new Sprite(this, 0, 0, 22, 16)],
          [new Sprite(this, 0, 0, 22, 16), new Sprite(this, 0, 0, 22, 16)]
        ];
        plSprite = new Sprite(this, 0, 0, 32, 32);
        bossSprite = [
          [new Sprite(this, 0, 0, 32, 32), new Sprite(this, 0, 0, 32, 32)]
        ];

        init();
        run();
      });
      img.src = "res/ge_min.png";
    };

    function init() {
      renderButtons();
      frames = 0;
      spFrame = 0;
      lvFrame = 50;
      waveCount = 1;
      dir = 1;

      player = {
        sprite: plSprite,
        x: (screen.width - plSprite.w) / 2,
        y: screen.height - (30 + plSprite.h)
      }

      projectiles = [];

      aliens = [];
      //set what types of monsters you want on each row
      var rows = [1, 0, 0 , 2, 2];
      //populate the 1st WAVE aliens array with monster objects
      for (var i = 0, len = rows.length; i < len; i++) {
        for (var j = 0; j < 10; j++) {
          var a = rows[i];
          aliens.push({
            sprite: sponserSprite[a],
            x: 30 + j*30 + [0, 0, 0][a],
            y: 30 + i*30,
            w: sponserSprite[a][0].w,
            h: sponserSprite[a][0].h
          });
        }
      }
    };

    function run() {
      console.log("Game Running!");
      var loop = function() {
        update();
        render();
        window.requestAnimationFrame(loop, screen.canvas);
      };
      window.requestAnimationFrame(loop, screen.canvas);
    };

    function update() {

      if (input.isDown(37)) { //LEFT
        player.x -= 15;
      }
      if (input.isDown(39)) { //RIGHT
        player.x += 15;
      }
      if (input.isDown(40)) { //UP
        player.y += 15;
      }
      if (input.isDown(38)) { //DOWN
        player.y -= 15;
      }
      //Max Width of movement
      player.x = Math.max(Math.min(player.x, screen.width - (30 + plSprite.w)), 30);
      //Max Height of movement
      player.y = Math.max(Math.min(player.y, screen.height - (30 + plSprite.h)), 300);

      //creates the projectiles
      if (true) {
        projectiles.push(new Projectile(player.x + 15, player.y - 34, -20, 2, 50, "#800080"));
      }

      for (var i = 0, len = projectiles.length; i < len; i++) {
        var p = projectiles[i];

        p.update();

        //Minbounds and Maxbounds for projectiles
        if (p.y + p.height < 0 || p.y > screen.height) {
          projectiles.splice(i, 1);
          i--;
          len--;
          continue;
        }
        //Remove aliens when hit with projectiles
        for (var j = 0, len2 = aliens.length; j < len2; j++) {
          var a = aliens[j];
          if (AABBIntersect(p.x, p.y, p.width, p.height, a.x, a.y, a.w, a.h)) {
            projectiles.splice(i, 1);
            i--;
            len--;
            if (a.boss === true) {
              //removes health from the boss on every hit
              console.log('You hit the boss!');
              a.health--;
              console.log(a.health);
              //Destroys the Boss if the health is zero
              if (a.health <= 0) {
                console.log('Boss is finished!');
                aliens.splice(j, 1);
                j--;
                len2--;
              }
            } else {
              aliens.splice(j, 1);
              j--;
              len2--;
            }
          }
        }
      }
      //Aliens to fire projectiles
      //Math.random generates number from [0.0, 1) multiple by 60 to get avg # of frames passed per shot
      if (Math.random() < 0.1 && aliens.length > 0) {
        //Select random alien object b to fire from alien objects array
        var a = aliens[Math.round(Math.random() * (aliens.length - 1))];
        //Go through entire aliens object array and compare if it matches randomly selected alien object a
        for (var i = 0, len = aliens.length; i < len; i++) {
          var b = aliens[i];

          if (AABBIntersect(a.x, a.y, a.w, 100, b.x, b.y, b.w, b.h)) {
            a = b;
          }
        }
        //Generate new projectile to be drawn and fired from selected alien object
        projectiles.push(new Projectile(a.x + a.w*0.5, a.y + a.h, 5, 3, 15, "#f00"));
      }

      //2ND WAVE
      //create a new alien object array when all monsters are destroyed
      if (aliens.length === 0 && waveCount === 1) {
        //set waveCount to 2nd Wave
        waveCount++;
        //set what types of monsters you want on each row
        var rows = [1, 0, 0 , 2, 2];
        //populate the aliens array with monster objects
        for (var i = 0, len = rows.length; i < len; i++) {
          for (var j = 0; j < 10; j++) {
            var a = rows[i];
            aliens.push({
              sprite: sponserSprite[a],
              x: 30 + j*30 + [0, 0, 0][a],
              y: 30 + i*30,
              w: sponserSprite[a][0].w,
              h: sponserSprite[a][0].h
            });
          }
        }
      }

      //BOSS LEVEL
      //create a new BOSS alien object array when all monsters are destroyed
      if (aliens.length === 0 && waveCount === 2) {
        //set waveCount to 2nd Wave
        waveCount++;
        //set what types of monsters you want on each row
        var rows = [0];
        //populate the aliens array with monster objects
        for (var i = 0, len = rows.length; i < len; i++) {
          for (var j = 0; j < 1; j++) {
            var a = rows[i];
            aliens.push({
              sprite: bossSprite[a],
              x: 200 + j*30,
              y: 100 + i*30,
              w: bossSprite[a][0].w,
              h: bossSprite[a][0].h,
              boss: true,
              health: 20
            });
          }
        }
      }

      //END CREDITS
      if (aliens.length === 0 && waveCount === 3) {
        //Display credits function
        endCredits();
        waveCount++;
          }

      frames++;
      if (frames % lvFrame === 0){
        spFrame = (spFrame + 1) % 2;

        var max_ = 0, min_ = screen.width;
        for (var i = 0, len = aliens.length; i < len; i++) {
          var a = aliens[i];
          a.x += 30 * dir;

          max_ = Math.max(max_, a.x + a.w);
          min_ = Math.min(min_, a.x);
        }

        if (max_ > screen.width -30 || min_ < 30) {
          dir *= -1;
          for (var i = 0, len = aliens.length; i < len; i++) {
            aliens[i].x += 30 * dir;
            aliens[i].y += 30;
          }
        }
      }
    };

    function render() {
      screen.clear();

      for (var i = 0, len = aliens.length; i < len; i++) {
        var a = aliens[i];
        screen.drawSprite(a.sprite[spFrame], a.x, a.y);
      }

      screen.ctx.save();
      for (var i = 0, len = projectiles.length; i < len; i++) {
        screen.drawProjectile(projectiles[i]);
      }
      screen.ctx.restore();

      screen.drawSprite(player.sprite, player.x, player.y);
    };

    function startScreen() {
      var myStartScreen = document.createElement('div');
      myStartScreen.setAttribute("style","width:504px; height:600px; font-family: arial; z-index: 1;");
      myStartScreen.id = 'myStartScreen';
      var titleName = document.createElement('h1');
      titleName.setAttribute("style","width:100%; height:60px; display: block; margin: auto; text-align: center; color: white;");
      titleName.innerHTML = 'Attack of the Sponsors';
      myStartScreen.appendChild(titleName);
      var startButton = document.createElement('button');
      startButton.setAttribute("style","width:250px; height:60px; display: block; margin: auto;");
      startButton.innerHTML = 'Start Game';
      startButton.setAttribute("onclick",'startGame();');
      myStartScreen.appendChild(startButton);
      var creditsButton = document.createElement('button');
      creditsButton.setAttribute("style","width:250px; height:60px; display: block; margin: auto;");
      creditsButton.innerHTML = 'Credits';
      creditsButton.setAttribute("onclick",'startToCredits();');
      myStartScreen.appendChild(creditsButton);

      document.body.appendChild(myStartScreen);
    };

    function startGame() {
      var startScreen = document.getElementById('myStartScreen');
      startScreen.style.setProperty("z-index"," -1");
      var oldcanv = document.getElementById('gameScreen');
      if (oldcanv) {
      document.body.removeChild(oldcanv);
      }
      mainGame();
    };

    function endCredits() {
      var myCreditsScreen = document.createElement('div');
      myCreditsScreen.setAttribute("style","width:504px; height:600px; font-family: arial;");
      myCreditsScreen.id = 'myCreditsScreen';
      var titleName = document.createElement('h1');
      titleName.setAttribute("style","width:100%; height:60px; display: block; margin: auto; text-align: center; color: white;");
      titleName.innerHTML = 'Credits';
      myCreditsScreen.appendChild(titleName);
      var startButton = document.createElement('button');
      startButton.setAttribute("style","width:250px; height:60px; display: block; margin: auto;");
      startButton.innerHTML = 'Menu';
      startButton.setAttribute("onclick",'creditsToStart();');
      myCreditsScreen.appendChild(startButton);

      document.body.appendChild(myCreditsScreen);
    };

    function creditsToStart() {
      var creditsScreen = document.getElementById('myCreditsScreen');
      creditsScreen.style.setProperty("z-index"," -1");
      var startScreen = document.getElementById('myStartScreen');
      startScreen.style.setProperty("z-index"," 1");
    };

    function startToCredits() {
      var creditsScreen = document.getElementById('myCreditsScreen');
      creditsScreen.style.setProperty("z-index"," 1");
      var startScreen = document.getElementById('myStartScreen');
      startScreen.style.setProperty("z-index"," -1");
    };

    function renderButtons() {
      var mobileControls = document.createElement('div');
      mobileControls.id = 'mobileControls';
      mobileControls.setAttribute("style","width:504px; height:33px; margin: auto; margin-top: 630px; top: 0; position: relative; z-index: 10;");
      document.body.appendChild(mobileControls);

      var leftButton = document.createElement('button');
      leftButton.setAttribute("style","width:252px; height:33px; margin-top: 504px; margin: auto; z-index: 10;");
      leftButton.innerHTML = '<';
      leftButton.setAttribute("onclick",'movePlayerLeft();');
      document.getElementById('mobileControls').appendChild(leftButton);

      var rightButton = document.createElement('button');
      rightButton.setAttribute("style","width:252px; height:33px; margin-top: 500px; margin-left: 252px; margin: auto; z-index: 10;");
      rightButton.innerHTML = '>';
      rightButton.setAttribute("onclick",'movePlayerRight();');
      document.getElementById('mobileControls').appendChild(rightButton);


    };

    function movePlayerLeft() {
      player.x -= 20;
    };

    function movePlayerRight() {
      player.x += 20;
    }

    //render movement buttons
    //Render the Start screen
    endCredits();
    startScreen();
    //Render the Credits screen

    //cheat by overlaying an html5 dialogue box over the canvas, and when the canvas is selected then start the game.
    // mainGame();
  </script>
</body>
</html>
